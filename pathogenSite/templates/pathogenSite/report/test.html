{% extends "pathogenSite/base.html" %}

{% block title %}Introduction Page{% endblock %}


{% block content %}
<div>
	<h3>Total Microbiome Distribution</h3>
	<div id="div1_table1" style="float:left;"></div>
	<div id="div1_pie1" style="float:left;"></div>
	<div id="div1_pie2" style="float:left;"></div>
</div>

<div style="clear:left;">
	<h3>Pathogen Distribution</h3>
	<div id="div2_pie1" style="float:left;"></div>
	<div id="div2_column1" style="float:right;"></div>
</div>

{% endblock %}

{% block script %}
<script src="https://www.google.com/jsapi"></script>
<script>
function ColorLuminance(hex, lum) {

	// validate hex string
	hex = String(hex).replace(/[^0-9a-f]/gi, '');
	if (hex.length < 6) {
		hex = hex[0]+hex[0]+hex[1]+hex[1]+hex[2]+hex[2];
	}
	lum = lum || 0;

	// convert to decimal and change luminosity
	var rgb = "#", c, i;
	for (i = 0; i < 3; i++) {
		c = parseInt(hex.substr(i*2,2), 16);
		c = Math.round(Math.min(Math.max(0, c + (c * lum)), 255)).toString(16);
		rgb += ("00"+c).substr(c.length);
	}
	return rgb;
}
function MakeGradientColors(hex, count){
	count = count;
	diff = 1/count;
	colors = [];
	for (i=0; i < count; i++){
		colors.push(ColorLuminance(hex, diff*i));
	}
	return colors;
}

// Load the Visualization API and the piechart package.
google.load('visualization', '1.0', {'packages':['corechart', 'table']});

// Total Microbiome Distribution
google.setOnLoadCallback(drawMicrobiomeChart);
function drawMicrobiomeChart() {
	// Create the data table.
	var data = new google.visualization.arrayToDataTable({{ genus|safe }});
	var view = new google.visualization.DataView(data);

	// Set chart options
	var options = {{ options|safe }};
	var species_all = {{ species|safe }};

	// Instantiate and draw our chart, passing in some options.
	var chart1 = new google.visualization.PieChart(
		document.getElementById('div1_pie1'));
	var chart2 = new google.visualization.PieChart(
		document.getElementById('div1_pie2'));
	var table1 = new google.visualization.Table(
		document.getElementById('div1_table1'));

	google.visualization.events.addListener(table1, 'sort', 
		function(event) {
			order = data.getSortedRows(
				[{column: event.column, desc: !event.ascending}]);
			tablePreToCur = {};
			tableCurToPre = {};
			for (i=0; i < order.length; i++){
				tablePreToCur[order[i]] = i;
				tableCurToPre[i] = order[i];
			};
			data.sort([{column: event.column, desc: !event.ascending}]);
			chart1.draw(data, options);
	});

	google.visualization.events.addListener(table1, 'select', function() {
		selection = table1.getSelection();
		if (selection.length > 0){
			if (typeof(tablePreToCur) !== 'undefined'){
				rowNum = tablePreToCur[selection[0].row];
			}else{
				rowNum = selection[0].row;
			};
			chart1.setSelection([{'column':null, 'row':rowNum}]);
			genus = data.getValue(rowNum,0);
			var species = 
				new google.visualization.arrayToDataTable(species_all[genus]);
			var initColor = options['colors'][rowNum];
			var gradientColors = MakeGradientColors(initColor, 5);
			var options_tt = 
				{'title': 'species('+ genus +')', 'width':400, 'height':300,
				'colors': gradientColors};
			chart2.draw(species, options_tt);
		};
	});
	google.visualization.events.addListener(chart1, 'select', function() {
		selection = chart1.getSelection();
		if (selection.length > 0){
			if (typeof(tableCurToPre) !== 'undefined'){
				rowNum = tableCurToPre[selection[0].row];
			}else{
				rowNum = selection[0].row;
			};
			table1.setSelection([{'row':rowNum, column:null}]);
			genus = data.getValue(selection[0].row,0);
			var species = 
				new google.visualization.arrayToDataTable(species_all[genus]);
			var initColor = options['colors'][selection[0].row];
			var gradientColors = MakeGradientColors(initColor, 5);
			var options_tt = 
				{'title': 'species('+ genus +')', 'width':400, 'height':300,
				'colors': gradientColors};
			chart2.draw(species, options_tt);
		}
	});

	table1.draw(data);
	$('#div1_table1 table').addClass('table');
	chart1.draw(data, options)
}

// Pathogen Distribution
google.setOnLoadCallback(drawPathogenChart);
function drawPathogenChart(){
	var dataPie1 = new google.visualization.arrayToDataTable({{ pathogen_portion|safe }});
	var pie1 = new google.visualization.PieChart(
		document.getElementById('div2_pie1'));
	pie1.draw(dataPie1, {'title':'Pathogen Proportion', 'width':400, 
		'height':300, 'colors': ['#109618', '#ff9900', '#dc3912']});

	var dataColumn1 = new google.visualization.arrayToDataTable({{ pathogen_organism|safe }});
	var column1 = new google.visualization.ColumnChart(
		document.getElementById('div2_column1'));
	column1.draw(dataColumn1, {'title':'Pathogens in Organisms', 'width':500, 
		'height':300, 'colors': ['#dc3912', '#ff9900'], 
		'legend':{'position':'right'}, 'isStacked':true});
};

</script>
{% endblock %}
